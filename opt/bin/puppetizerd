#!/bin/sh -e

#
# Author: Arkadiusz DziÄ™giel <arkadiusz.dziegiel@glorpen.pl>
#

. /opt/puppetizer/share/common.sh

run_startup()
{
	find_scripts "${puppetizer_scripts_dir}" -name '*.init' | run_scripts_sync
	
	echo "Configuring environment..."
	
	# apply puppet manifests and check for exit code
	puppet_apply # puppet will start services
	
	find_scripts "${puppetizer_scripts_dir}" -name '*.start' | run_scripts_sync
	
	touch "${puppetizer_initialized_token}"
}

run_shutdown()
{
	echo "## Running stop scripts ##"
	find_scripts "${puppetizer_scripts_dir}" -name '*.stop' | run_scripts_sync
	echo "## Stopping services ##"
	find_scripts "${puppetizer_services_dir}" -name '*.stop' | run_scripts_sync
	echo "## Running shutdown scripts ##"
	find_scripts "${puppetizer_scripts_dir}" -name '*.shutdown' | run_scripts_sync
	
	echo "All scripts executed, exitting."
	exit 0;
}

trap '{ run_shutdown; }' TERM INT
trap '{ puppet_apply || true; }' HUP


echo "Puppetized container is running"

run_startup

if [ "z${1}" != "z" ];
then
	# run docker CMD
	exec $@
else
	if [ $puppetizer_os == 'alpine' ];
	then
		( while :; do sleep 365d; done )&
	else
		sleep infinity &
	fi
	while :; do
		wait || echo "Handled signal $?"
	done
fi
