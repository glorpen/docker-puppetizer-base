#!/bin/sh

#
# Author: Arkadiusz DziÄ™giel <arkadiusz.dziegiel@glorpen.pl>
#

runsvdir="/opt/puppetizer/bin/runsvdir"

do_init(){
    puppet_apply || kill -TERM 0
    
    touch "${puppetizer_initialized_token}"
    echo "Container marked as initialized"
}

delayed_start(){
    . /opt/puppetizer/share/common.sh
    
    while :;
    do
        pkill -0 -f "${runsvdir}" && ( do_init; exit 0 ) 
        sleep 1s
    done
}

delayed_start &

exec ${runsvdir} /opt/puppetizer/service
